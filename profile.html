<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>User Profile</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #1f1f1f;
      display: flex; 
      justify-content: center; 
      align-items: center;
      height: 100vh; padding: 15px;
      overflow: hidden;
    }
    .box {
      display: flex; flex-direction: column; align-items: center;
      width: 30vw; min-width: 300px;
      background: #000; padding: 40px 30px;
      border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.25);
      text-align: center;
    }
    .circle { 
      display: flex; justify-content: center; align-items: center; 
      height: 100px; width: 100px; border-radius: 50%; 
      background-color: silver; margin-right: 20px; 
    }
    .email-container { width: 100%; display: flex; flex-direction: column; gap: 8px; margin-top: 30px;}
    .email-container p { display: flex; justify-content: start; align-items: center; gap: 10px; font-size: 16px; font-weight: 600; color: #fff; }
    .email-container span { color: #ABFF2F; }
    input {
      padding: 8px 10px; border-radius: 8px; border: none;
      outline: 2px solid #fff; color: #fff;
      background-color: transparent; font-size: 14px; width: 100%;
    }
    .btn-group { display: flex; gap: 10px; width: 100%; margin-top: 15px; }
    button {
      padding: 12px 20px; background: #fff; color: #000;
      border: none; font-size: 16px; font-weight: 600;
      border-radius: 10px; cursor: pointer; flex: 1; height: 50px;
    }
    button:hover { background: #ABFF2F; }
    #cancelBtn { display: none; background: #444; color: #fff; }
    #cancelBtn:hover { background: red; }
    #message { margin-top: 10px; font-size: 14px; font-weight: 600; color: #fff; }
    #message a { text-decoration: none; color: #ABFF2F; font-weight: 900; transition: all 0.3s ease; }
    #message a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <div class="box">
    <div class="circle"><i class="fa-solid fa-user fa-2x"></i></div>
    <div class="email-container">
      <p>Name: <span id="name"></span></p>
      <p>Email: <span id="email"></span></p>
      <p>Created: <span id="created"></span></p>
    </div>
    <div class="btn-group">
      <button id="editBtn">Edit</button>
      <button id="cancelBtn">Cancel</button>
    </div>
    <p id="message"></p>
  </div>

  <script type="module">
    import { auth, db } from "./firebase.js";
    import {
      onAuthStateChanged,
      updateProfile
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    window.addEventListener("DOMContentLoaded", () => {
      const nameSpan = document.getElementById("name");
      const emailSpan = document.getElementById("email");
      const createdSpan = document.getElementById("created");
      const editBtn = document.getElementById("editBtn");
      const cancelBtn = document.getElementById("cancelBtn");
      const msg = document.getElementById("message");

      let userRef = null;
      let isEditing = false;

      function showMessage(text, type = "info") {
        msg.style.color =
          type === "error" ? "red" :
          type === "success" ? "lime" :
          "orange";
        msg.innerHTML = text;  // innerHTML lets us add <a> link
      }

      async function loadUserData() {
        if (!userRef) return;
        const snap = await getDoc(userRef);
        if (snap.exists()) {
          const data = snap.data();
          nameSpan.textContent = data.name || "N/A";
          emailSpan.textContent = data.email || "N/A";
          createdSpan.textContent = data.createdAt?.toDate?.().toLocaleString() || "N/A";
        } else {
          showMessage("User data not found!", "error");
        }
      }

      // Listen for auth state
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          userRef = doc(db, "users", user.uid);
          await loadUserData();
        } else {
          showMessage(
            'No user logged in <a href="authentication.html">Login here</a>',
            "info"
          );
          msg.style.color = "silver";
          msg.style.fontWeight = "700";
        }
      });

      // Edit button
      editBtn.addEventListener("click", async () => {
        if (!isEditing) {
          nameSpan.innerHTML = `<input id="editName" value="${nameSpan.textContent}">`;
          editBtn.textContent = "Save";
          cancelBtn.style.display = "block";
          isEditing = true;
          return;
        }

        const newName = document.getElementById("editName").value.trim();
        if (!newName) return showMessage("Name cannot be empty.", "error");

        try {
          if (auth.currentUser?.displayName !== newName) {
            await updateProfile(auth.currentUser, { displayName: newName });
          }

          await updateDoc(userRef, { name: newName });

          showMessage("Name updated successfully!", "success");
          editBtn.textContent = "Edit";
          cancelBtn.style.display = "none";
          isEditing = false;
          await loadUserData();
          setTimeout(() => showMessage(""), 2000);

        } catch (err) {
          console.error("Update error:", err);
          showMessage("Something went wrong. Please try again.", "error");
        }
      });

      // Cancel button
      cancelBtn.addEventListener("click", async () => {
        await loadUserData();
        editBtn.textContent = "Edit";
        cancelBtn.style.display = "none";
        isEditing = false;
        showMessage("Edit cancelled", "info");
        setTimeout(() => showMessage(""), 1500);
      });
    });
  </script>
</body>
</html>