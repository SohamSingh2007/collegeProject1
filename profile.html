<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>User Profile</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #1f1f1f;
      display: flex; 
      justify-content: center; 
      align-items: center;
      height: 100vh; padding: 15px;
      overflow: hidden;
    }
    .box {
      display: flex; flex-direction: column; align-items: center;
      width: 30vw; min-width: 300px;
      background: #000; padding: 40px 30px;
      border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.25);
      text-align: center;
    }
    /* .section1 { display: flex; flex-direction: column; align-items: center; margin-bottom: 40px; width: 100%; } */
    .circle { 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      height: 100px; 
      width: 100px; 
      border-radius: 50%; 
      background-color: silver; 
      margin-right: 20px; 
    }

    .email-container { width: 100%; height: auto; display: flex; flex-direction: column; gap: 8px; margin-top: 30px;}

    .email-container p { 
      display: flex; 
      justify-content: start; 
      align-items: center;
      gap: 10px;
      font-size: 16px; 
      font-weight: 600; 
      color: #fff; 
    }

    .email-container span { color: #ABFF2F; }
    input {
      padding: 8px 10px; 
      border-radius: 8px; 
      border: none;
      outline: 2px solid #fff;
      color: #fff;
      background-color: transparent;
      font-size: 14px; 
      width: 100%;
    }
    button {
      padding: 12px 20px; background: #fff; color: #000;
      border: none; font-size: 16px; font-weight: 600;
      border-radius: 10px; cursor: pointer; width: 100%; height: 50px;
      margin-top: 15px;
    }
    button:hover { background: #ABFF2F; }
    #message { margin-top: 10px; font-size: 14px; font-weight: 600; color: #fff; }
  </style>
</head>
<body>
  <div class="box">
    <!-- <section class="section1"> -->
      <div class="circle"><i class="fa-solid fa-user fa-2x"></i></div>
      <div class="email-container">
          <p>Name: <span id="name"></span></p>
          <p>Email: <span id="email"></span></p>
          <p>Created: <span id="created"></span></p>
      </div>
    <!-- </section> -->

    <button id="editBtn">Edit</button>
    <p id="message"></p>
  </div>

  <script type="module">
    import { auth, db } from "./firebase.js";
    import { onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const nameSpan = document.getElementById("name");
    const emailSpan = document.getElementById("email");
    const createdSpan = document.getElementById("created");
    const editBtn = document.getElementById("editBtn");
    const msg = document.getElementById("message");

    let userRef = null;
    let isEditing = false;

    // ✅ Watch for logged-in user
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        userRef = doc(db, "users", user.uid);
        loadUserData();
      } else {
        msg.textContent = "⚠️ No user logged in.";
      }
    });

    // ✅ Load user data
    async function loadUserData() {
      if (!userRef) return;
      const snap = await getDoc(userRef);
      if (snap.exists()) {
        const data = snap.data();
        nameSpan.textContent = data.name || "N/A";
        emailSpan.textContent = data.email || "N/A";
        createdSpan.textContent = data.createdAt?.toDate?.().toLocaleString() || "N/A";
      } else {
        msg.textContent = "User data not found!";
      }
    }

    // ✅ Edit / Save button
    editBtn.addEventListener("click", async () => {
      if (!isEditing) {
        // Switch to edit mode
        nameSpan.innerHTML = `<input id="editName" value="${nameSpan.textContent}">`;
        emailSpan.innerHTML = `<input id="editEmail" value="${emailSpan.textContent}">`;
        createdSpan.textContent = createdSpan.textContent; // keep createdAt as is (not editable)
        editBtn.textContent = "Save";
        isEditing = true;
      } else {
        // Save back to Firestore
        const newName = document.getElementById("editName").value;
        const newEmail = document.getElementById("editEmail").value;

        try {
          await updateDoc(userRef, {
            name: newName,
            email: newEmail
          });

          // Also update Firebase Auth displayName & email
          if (auth.currentUser) {
            await updateProfile(auth.currentUser, { displayName: newName });
          }

          msg.style.color = "green";
          msg.textContent = "Updated successfully!";
          editBtn.textContent = "Edit";
          isEditing = false;
          loadUserData();
          setTimeout(() => {
            msg.textContent = "";
          }, 2000);
        } catch (err) {
          let friendlyMsg = "Something went wrong. Please try again.";

          if (err.code === "permission-denied") {
            friendlyMsg = "You don’t have permission to update this data.";
          } else if (err.code === "unavailable") {
              friendlyMsg = "Server is temporarily unavailable. Please retry shortly.";
          } else if (err.code === "invalid-argument") {
              friendlyMsg = "Your input data seems invalid. Please check and retry.";
          } else if (err.code === "auth/email-already-in-use") {
              friendlyMsg = "This email is already registered with another account.";
          } else if (err.code === "auth/invalid-email") {
              friendlyMsg = "Please enter a valid email address.";
          }

          showMessage(friendlyMsg, true); // 🔴 always red for errors
        }
      }
    });
  </script>
</body>
</html>
