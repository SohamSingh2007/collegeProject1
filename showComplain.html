<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ComplainEasy: Complaints</title>
    <link rel="shortcut icon" href="logo.svg" type="svg">

    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --accent: #abff2f;
        --bg-main: #000000;
        --bg-card: #111111;
        --text-main: #f5f5f5;
        --text-muted: #aaaaaa;
        --border: #222222;
      }

      body {
        font-family: "Inter", sans-serif;
        background-color: var(--bg-main);
        color: var(--text-main);
        margin: 0;
        padding: 20px;
        scrollbar-width: none;
        -ms-overflow-style: none;
      }

      ::-webkit-scrollbar {
        width: 0;
        height: 0;
      }

      .container {
        max-width: 1000px;
        max-height: 500px;
        margin: 0 auto;
        background: var(--bg-card);
        padding: 25px;
        border-radius: 12px;
        border: 1px solid var(--border);
        overflow-x: auto;
      }

      h1 {
        margin-bottom: 10px;
        color: #fff;
      }
      .subtitle {
        color: var(--text-muted);
        margin-bottom: 20px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        text-align: left;
        color: var(--text-main);
        min-width: 600px;
      }

      thead {
        background-color: #3b473f;
        color: #fff;
        font-weight: 600;
      }
      th,
      td {
        padding: 12px 14px;
        border-bottom: 1px solid var(--border);
        vertical-align: middle;
      }
      tbody tr:hover {
        background-color: rgba(171, 255, 47, 0.1);
        transition: 0.3s;
      }

      .AllButton {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      button.btn {
        background-color: rgb(66, 66, 227);
        color: #fff;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
      }
      button.btn:hover {
        transform: scale(1.03);
      }
      button.btn.show {
        background-color: #fff;
        color: #000000;
      }

      .loading {
        text-align: center;
        color: var(--text-muted);
        padding: 20px;
      }

      /* Modal */
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
        padding: 10px;
      }
      .modal.hidden {
        display: none;
      }
      .modal-content {
        position: relative;
        background: var(--bg-card);
        padding: 25px;
        border-radius: 12px;
        width: 100%;
        max-width: 400px;
        border: 1px solid var(--border);
        color: var(--text-main);
        max-height: 90vh;
        overflow-y: auto;
      }

      .close-icon {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 22px;
        color: #ef4444;
        cursor: pointer;
        font-weight: bold;
        transition: 0.3s;
      }
      .close-icon:hover {
        color: #f87171;
        transform: scale(1.2);
      }

      .details-box {
        width: 100%;
        max-height: 200px;
        background-color: #0a0a0a;
        padding: 10px;
        border-radius: 8px;
        margin-top: 10px;
        white-space: pre-wrap;
        overflow-y: auto;
        border: 1px solid var(--border);
        box-sizing: border-box;
      }

      .status {
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      /* STATUS COLORS */
      .status.new {
        color: #fbbf24;
      }
      .status.pending {
        color: #facc15;
      }
      .status.started {
        color: #3b82f6;
      }
      .status.completed {
        color: #22c55e;
      }
      .status.rejected {
        color: #ef4444;
      }

      .dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
      }
      .dot.new {
        background-color: #fbbf24;
      }
      .dot.pending {
        background-color: #facc15;
      }
      .dot.started {
        background-color: #3b82f6;
      }
      .dot.completed {
        background-color: #22c55e;
      }
      .dot.rejected {
        background-color: #ef4444;
      }

      /* Pagination */
      #pagination {
        margin-top: 15px;
        text-align: center;
      }
      #pagination button {
        margin: 0 3px;
      }
      #prevPage,
      #nextPage {
        background-color: #3b473f;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h1>All Complaints</h1>
      <p class="subtitle">Below is the list of submitted complaints.</p>

      <table id="complaintsTable">
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Subject</th>
            <th>Date of Incident</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="complaintsBody">
          <tr>
            <td colspan="6" class="loading">Loading complaints...</td>
          </tr>
        </tbody>
      </table>

      <div id="pagination">
        <button id="prevPage" class="btn">Prev</button>
        <span id="pageInfo">Page 1</span>
        <button id="nextPage" class="btn">Next</button>
      </div>
    </div>

    <!-- Modal -->
    <div id="detailsModal" class="modal hidden">
      <div class="modal-content">
        <span class="close-icon" id="closeModal">&times;</span>
        <h2 style="color: var(--accent)">Complaint Details</h2>
        <p><strong>Name:</strong> <span id="modalName"></span></p>
        <p><strong>Email:</strong> <span id="modalEmail"></span></p>
        <p><strong>Subject:</strong> <span id="modalSubject"></span></p>
        <p><strong>Date of Incident:</strong> <span id="modalDate"></span></p>
        <p><strong>Details:</strong></p>
        <p id="modalDetails" class="details-box"></p>
        <hr style="border-color: var(--border); margin: 15px 0" />
        <h3 style="color: var(--accent)">Update Status</h3>
        <div style="display: flex; gap: 10px; flex-wrap: wrap">
          <button class="btn statusBtn" data-status="Started" style="background-color: #3b82f6;">Start</button>
          <button class="btn statusBtn" data-status="Completed" style="background-color: #22c55e">Completed</button>
          <button class="btn statusBtn" data-status="Rejected" style="background-color: #ef4444">Rejected</button>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        onSnapshot,
        orderBy,
        query,
        doc,
        updateDoc,
      } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyC64IVQh13WplDDX-clQ1RjaUg_X1MJvcE",
        authDomain: "fieldproject-21f1d.firebaseapp.com",
        projectId: "fieldproject-21f1d",
        storageBucket: "fieldproject-21f1d.firebasestorage.app",
        messagingSenderId: "211444513819",
        appId: "1:211444513819:web:28b909dc140cac64944cbe",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      const complaintsBody = document.getElementById("complaintsBody");
      const modal = document.getElementById("detailsModal");
      const closeModal = document.getElementById("closeModal");

      const modalName = document.getElementById("modalName");
      const modalEmail = document.getElementById("modalEmail");
      const modalSubject = document.getElementById("modalSubject");
      const modalDate = document.getElementById("modalDate");
      const modalDetails = document.getElementById("modalDetails");

      let currentComplaintId = null;

      const rowsPerPage = 3;
      let currentPage = 1;
      let complaintsData = [];

      const q = query(collection(db, "complain"), orderBy("dateOfIncident", "desc"));

      onSnapshot(q, async (snapshot) => {
        complaintsData = [];
        for (const docSnap of snapshot.docs) {
          const data = { id: docSnap.id, ...docSnap.data() };
          if (!data.status) {
            await updateDoc(doc(db, "complain", data.id), { status: "New" });
            data.status = "New";
          }
          complaintsData.push(data);
        }
        currentPage = 1;
        renderPage();
      });

      function renderPage() {
        complaintsBody.innerHTML = "";
        if (!complaintsData.length) {
          complaintsBody.innerHTML = `<tr><td colspan="6" class="loading">No complaints found.</td></tr>`;
          document.getElementById("pageInfo").textContent = "Page 0";
          return;
        }

        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const pageData = complaintsData.slice(start, end);

        pageData.forEach((data) => {
          const date = data.dateOfIncident?.toDate
            ? data.dateOfIncident.toDate()
            : new Date(data.dateOfIncident);
          const formattedDate = date.toLocaleDateString("en-IN", {
            year: "numeric",
            month: "short",
            day: "numeric",
          });
          const status = data.status || "New";
          const statusClass = status.toLowerCase();

          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${data.Name || "N/A"}</td>
            <td>${data.Email || "N/A"}</td>
            <td>${data.subject || "N/A"}</td>
            <td>${formattedDate}</td>
            <td><span class="status ${statusClass}"><span class="dot ${statusClass}"></span> ${status}</span></td>
            <td class="AllButton">
              <button class="btn show" data-id="${data.id}">Show</button>
            </td>
          `;

          row.querySelector(".show").addEventListener("click", () => {
            modalName.textContent = data.Name || "N/A";
            modalEmail.textContent = data.Email || "N/A";
            modalSubject.textContent = data.subject || "N/A";
            modalDate.textContent = formattedDate;
            modalDetails.textContent = data.details || "No details provided.";
            currentComplaintId = data.id;
            modal.classList.remove("hidden");
          });

          complaintsBody.appendChild(row);
        });

        document.getElementById("pageInfo").textContent = `Page ${currentPage} of ${Math.ceil(complaintsData.length / rowsPerPage)}`;
      }

      document.getElementById("prevPage").addEventListener("click", () => {
        if (currentPage > 1) {
          currentPage--;
          renderPage();
        }
      });

      document.getElementById("nextPage").addEventListener("click", () => {
        if (currentPage < Math.ceil(complaintsData.length / rowsPerPage)) {
          currentPage++;
          renderPage();
        }
      });

      // ✅ Working status update logic
      document.querySelectorAll(".statusBtn").forEach((btn) => {
        btn.addEventListener("click", async () => {
          if (!currentComplaintId) return;
          const newStatus = btn.getAttribute("data-status");
          try {
            await updateDoc(doc(db, "complain", currentComplaintId), { status: newStatus });
            alert(`Status updated to ${newStatus} ✅`);
            modal.classList.add("hidden");
          } catch (err) {
            console.error(err);
            alert("Failed to update status. Check console.");
          }
        });
      });

      closeModal.addEventListener("click", () => modal.classList.add("hidden"));
      modal.addEventListener("click", (e) => {
        if (e.target === modal) modal.classList.add("hidden");
      });
    </script>
  </body>
</html>